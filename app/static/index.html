<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Диспетчер задач</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Шрифт: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    /* Softer surfaces & chips */
    .surface { @apply bg-white rounded-3xl shadow-sm border border-gray-200; }
    .chip    { @apply inline-flex items-center gap-1 rounded-full px-2.5 py-0.5 text-xs font-medium bg-gray-100 text-gray-700; }
    .muted   { @apply text-gray-500; }
    .section { @apply text-lg font-medium text-gray-900; }
    .toolbar { @apply flex gap-2 items-center; }
    /* Базовые элементы (мягкие «пузырьки») */
    .card { @apply bg-white rounded-3xl shadow-sm border border-gray-200 p-6; }
    .btn  { @apply inline-flex items-center justify-center px-4 py-2 rounded-full text-sm font-medium transition shadow-sm border focus:outline-none focus:ring-2 focus:ring-blue-400; }
    .btn-primary { @apply bg-blue-600 text-white border-blue-600 hover:bg-blue-700; }
    .btn-ghost   { @apply bg-white text-gray-800 border-gray-300 hover:bg-gray-50; }
    .btn-danger  { @apply bg-white text-red-700 border-red-300 hover:bg-red-50; }
    .input { @apply w-full rounded-full border border-gray-300 bg-white px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400; }
    .pill  { @apply inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium; }
    /* Colored chips and card accents for visual clarity */
    .chip-open { @apply bg-blue-50 text-blue-700 border border-blue-200; }
    .chip-done { @apply bg-emerald-50 text-emerald-700 border border-emerald-200; }
    .card-open { @apply border-l-4 border-blue-300; }
    .card-done { @apply border-l-4 border-emerald-300; }
  </style>
</head>

<!-- Визуально центрируем всё по странице -->
<body class="min-h-screen bg-gradient-to-b from-gray-50 to-gray-100">
  <div class="max-w-xl mx-auto px-5 py-10 md:py-16 space-y-6 min-h-[85vh] flex flex-col justify-center">

    <!-- Header -->
    <header class="flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-semibold tracking-tight text-gray-900">Диспетчер задач</h1>
      <div id="userBox" class="hidden items-center gap-3">
        <span id="userEmail" class="text-sm text-gray-600"></span>
        <button id="logoutBtn" class="btn btn-ghost">Выйти</button>
      </div>
    </header>

    <!-- Auth -->
    <section id="authCard" class="card">
      <h2 class="text-lg font-medium mb-4">Войти или зарегистрироваться</h2>
      <div class="grid grid-cols-1 gap-4">
        <div class="space-y-3">
          <label class="block">
            <span class="block text-sm text-gray-600 mb-1">Email</span>
            <input id="email" type="email" class="input" placeholder="name@example.com" />
          </label>
          <label class="block">
            <span class="block text-sm text-gray-600 mb-1">Пароль</span>
            <input id="password" type="password" class="input" placeholder="Минимум 6 символов" />
          </label>
          <label class="block">
            <span class="block text-sm text-gray-600 mb-1">Имя (необязательно)</span>
            <input id="fullName" type="text" class="input" placeholder="Например, Анна Иванова" />
          </label>

          <div class="flex gap-2">
            <button id="loginBtn" class="btn btn-primary">Войти</button>
            <button id="signupBtn" class="btn btn-ghost">Зарегистрироваться</button>
          </div>

          <p id="authMsg" class="text-sm text-gray-600"></p>
        </div>
      </div>
    </section>

    <!-- Tasks -->
    <section id="tasksCard" class="card hidden">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-2">
        <h2 class="section">Мои задачи</h2>
        <div class="toolbar">
          <input id="filterInput" class="input w-64 placeholder-gray-400" placeholder="Фильтр по названию" />
          <button id="refreshBtn" class="btn btn-ghost">Обновить</button>
        </div>
      </div>

      <form id="createForm" class="grid grid-cols-1 md:grid-cols-[1fr_1fr_auto] gap-2 mb-4">
        <input id="newTitle" class="input placeholder-gray-400" placeholder="Название задачи" required />
        <input id="newDesc" class="input placeholder-gray-400" placeholder="Описание (необязательно)" />
        <button class="btn btn-primary shadow" type="submit">Добавить</button>
      </form>

      <div id="list" class="space-y-3"></div>

      <template id="rowTpl">
        <div class="surface p-4 hover:bg-gray-50 transition">
          <div class="flex items-start gap-3">
            <input type="checkbox" class="mt-1.5 shrink-0 accent-blue-600" data-role="done" />
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <span data-role="title" class="font-medium truncate text-base"></span>
                <span data-role="status" class="chip"></span>
              </div>
              <div data-role="desc" class="text-sm text-gray-500 mt-1"></div>

              <div class="mt-3 flex gap-2">
                <button class="btn btn-ghost" data-role="edit">Изменить</button>
                <button class="btn btn-primary hidden" data-role="save">Сохранить</button>
                <button class="btn btn-ghost hidden" data-role="cancel">Отмена</button>
                <button class="btn btn-danger" data-role="delete">Удалить</button>
              </div>
            </div>
          </div>
        </div>
      </template>
    </section>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-6 hidden">
    <div class="bg-black text-white text-sm px-4 py-2 rounded-full shadow-lg" id="toastMsg"></div>
  </div>

  <!-- JS: функции БЕЗ изменений -->
  <script>
    const API = ""; // same origin
    const $ = (s, r=document)=>r.querySelector(s);
    const state = { access: localStorage.getItem("access") || "", me: null, tasks: [] };

    // toast
    function toast(msg, ms=2200){
      const box = $("#toast"), msgEl = $("#toastMsg");
      msgEl.textContent = msg; box.classList.remove("hidden");
      setTimeout(()=> box.classList.add("hidden"), ms);
    }

    // api helper (учитывает 204/пустые ответы)
    async function api(path, {method="GET", json, form, auth=true}={}) {
      const headers = {};
      if (json) { headers["Content-Type"] = "application/json"; }
      if (auth && state.access) { headers["Authorization"] = "Bearer " + state.access; }
      const body = json ? JSON.stringify(json) : (form ? new URLSearchParams(form) : undefined);

      const res = await fetch(API + path, { method, headers, body });

      if (!res.ok) {
        let detail = "Ошибка запроса";
        try {
          const ctErr = res.headers.get("content-type") || "";
          if (ctErr.includes("application/json")) {
            const d = await res.json();
            detail = d.detail || JSON.stringify(d);
          } else {
            detail = await res.text();
          }
        } catch {}
        throw new Error(typeof detail === "string" ? detail : JSON.stringify(detail));
      }

      if (res.status === 204 || res.status === 205) return null;
      const len = res.headers.get("content-length");
      if (len === "0") return null;

      const ct = res.headers.get("content-type") || "";
      if (ct.includes("application/json")) {
        const text = await res.text();
        if (!text) return null;
        try { return JSON.parse(text); } catch { return null; }
      }
      return res.text();
    }

    // endpoints
    const authApi = {
      signup: (email, password, full_name)=> api("/api/auth/signup",{method:"POST", json:{email, password, full_name}, auth:false}),
      login: (email, password)=> api("/api/auth/login",{method:"POST", form:{username:email, password}, auth:false}),
      me: ()=> api("/api/users/me"),
    };
    const tasksApi = {
      listMine: ()=> api("/api/tasks/"),
      create: (title, description)=> api("/api/tasks/", {method:"POST", json:{title, description}}),
      patch: (id, payload)=> api(`/api/tasks/${id}`, {method:"PATCH", json:payload}),
      del: (id)=> api(`/api/tasks/${id}`, {method:"DELETE"}),
    };

    // UI state
    function setLoggedIn(me){
      state.me = me;
      $("#userEmail").textContent = me.email;
      $("#userBox").classList.remove("hidden");
      $("#authCard").classList.add("hidden");
      $("#tasksCard").classList.remove("hidden");
      refreshTasks();
    }
    function setLoggedOut(msg=""){
      state.me = null; state.access = "";
      localStorage.removeItem("access");
      $("#userBox").classList.add("hidden");
      $("#authCard").classList.remove("hidden");
      $("#tasksCard").classList.add("hidden");
      if(msg) toast(msg);
    }

    // render
    function renderList(){
      const filter = $("#filterInput").value.trim().toLowerCase();
      const root = $("#list");
      root.innerHTML = "";
      const tpl = $("#rowTpl");

      const items = state.tasks.filter(t => !filter || t.title.toLowerCase().includes(filter));
      if(!items.length){
        const empty = document.createElement("div");
        empty.className = "text-center muted py-10";
        empty.textContent = "Задач пока нет.";
        root.appendChild(empty);
        return;
      }

      for(const task of items){
        const node = tpl.content.cloneNode(true);
        const el = node.children[0];
        const done = el.querySelector('[data-role="done"]');
        const title = el.querySelector('[data-role="title"]');
        const desc = el.querySelector('[data-role="desc"]');
        const status = el.querySelector('[data-role="status"]');
        const btnEdit = el.querySelector('[data-role="edit"]');
        const btnSave = el.querySelector('[data-role="save"]');
        const btnCancel = el.querySelector('[data-role="cancel"]');
        const btnDelete = el.querySelector('[data-role="delete"]');

        title.textContent = task.title;
        desc.textContent = task.description || "—";
        done.checked = !!task.is_completed;
        setStatus(task.is_completed);

        function setStatus(v){
          status.textContent = v ? "Готово" : "Открыта";
          // colored chip styles
          status.className = v ? "chip chip-done" : "chip chip-open";
          // card left accent for quick scanning
          el.classList.remove("card-open", "card-done");
          el.classList.add(v ? "card-done" : "card-open");
        }

        done.addEventListener("change", async ()=>{
          const updated = await tasksApi.patch(task.id, { is_completed: done.checked });
          task.is_completed = updated.is_completed;
          setStatus(task.is_completed);
          toast(task.is_completed ? "Отмечено как выполнено" : "Снята отметка о выполнении");
        });

        // edit
        btnEdit.addEventListener("click", ()=>{
          btnEdit.classList.add("hidden"); btnSave.classList.remove("hidden"); btnCancel.classList.remove("hidden");

          const tIn = document.createElement("input");
          tIn.className = "input"; tIn.value = task.title;
          const dIn = document.createElement("input");
          dIn.className = "input mt-2"; dIn.value = task.description || "";

          title.replaceWith(tIn); desc.replaceWith(dIn);

          btnSave.onclick = async ()=>{
            const updated = await tasksApi.patch(task.id, { title: tIn.value, description: dIn.value });
            task.title = updated.title; task.description = updated.description;
            toast("Задача обновлена");
            renderList();
          };
          btnCancel.onclick = ()=> renderList();
        });

        // delete
        btnDelete.addEventListener("click", async (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (!confirm("Удалить задачу?")) return;
          try {
            await tasksApi.del(task.id);
            state.tasks = await tasksApi.listMine();
            renderList();
            toast("Задача удалена");
          } catch (err) {
            toast("Не удалось удалить задачу");
            console.error(err);
          }
        });

        root.appendChild(el);
      }
    }

    async function refreshTasks(){
      state.tasks = await tasksApi.listMine();
      renderList();
    }

    // events
    $("#signupBtn").addEventListener("click", async ()=>{
      const email = $("#email").value.trim();
      const password = $("#password").value;
      const full_name = $("#fullName").value.trim() || null;

      if(password.length < 6){ toast("Пароль должен содержать минимум 6 символов"); return; }

      try{
        const res = await authApi.signup(email, password, full_name);
        state.access = res.access_token; localStorage.setItem("access", state.access);
        const me = await authApi.me(); setLoggedIn(me);
        toast("Регистрация выполнена");
      }catch(e){ $("#authMsg").textContent = cleanErr(e.message); }
    });

    $("#loginBtn").addEventListener("click", async ()=>{
      const email = $("#email").value.trim();
      const password = $("#password").value;
      try{
        const res = await authApi.login(email, password);
        state.access = res.access_token; localStorage.setItem("access", state.access);
        const me = await authApi.me(); setLoggedIn(me);
        toast("Вы вошли в систему");
      }catch(e){ $("#authMsg").textContent = "Неверный email или пароль"; }
    });

    $("#logoutBtn").addEventListener("click", ()=> setLoggedOut("Вы вышли из аккаунта"));

    $("#createForm").addEventListener("submit", async (ev)=>{
      ev.preventDefault();
      const title = $("#newTitle").value.trim();
      const description = $("#newDesc").value.trim();
      if(!title) return;
      const created = await tasksApi.create(title, description || null);
      state.tasks.unshift(created);
      $("#newTitle").value = ""; $("#newDesc").value = "";
      toast("Задача добавлена");
      renderList();
    });

    $("#refreshBtn").addEventListener("click", refreshTasks);
    $("#filterInput").addEventListener("input", renderList);

    function cleanErr(s){
      try {
        const obj = JSON.parse(s);
        if(Array.isArray(obj.detail) && obj.detail[0]?.msg) return obj.detail[0].msg;
        if(typeof obj.detail === "string") return obj.detail;
      } catch {}
      return s;
    }

    // auto-restore session
    (async ()=>{
      if(!state.access) return;
      try{ const me = await authApi.me(); setLoggedIn(me); } catch { setLoggedOut(); }
    })();
  </script>
</body>
</html>