<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Task Manager</title>
  <!-- Tailwind via Play CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* приятные мелочи */
    .card { @apply bg-white/70 backdrop-blur rounded-2xl shadow p-6; }
    .btn  { @apply px-4 py-2 rounded-xl shadow text-sm font-medium hover:opacity-90 active:scale-[.98] transition; }
    .btn-primary { @apply bg-blue-600 text-white; }
    .btn-ghost { @apply bg-gray-100; }
    .input { @apply w-full rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500; }
    .chip  { @apply inline-flex items-center rounded-full px-3 py-1 text-xs font-medium bg-gray-100; }
    .muted { @apply text-gray-500; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-sky-50 to-indigo-50">
  <div class="max-w-4xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-semibold">Task Manager</h1>
      <div id="userBox" class="hidden items-center gap-3">
        <span id="userEmail" class="chip"></span>
        <button id="logoutBtn" class="btn btn-ghost">Logout</button>
      </div>
    </header>

    <!-- Auth -->
    <section id="authCard" class="card">
      <h2 class="text-lg font-medium mb-4">Sign in / Sign up</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-3">
          <input id="email" type="email" class="input" placeholder="Email" />
          <input id="password" type="password" class="input" placeholder="Password (min 6)" />
          <input id="fullName" type="text" class="input" placeholder="Full name (optional for signup)" />
          <div class="flex gap-2">
            <button id="loginBtn" class="btn btn-primary">Login</button>
            <button id="signupBtn" class="btn btn-ghost">Sign up</button>
          </div>
          <p id="authMsg" class="text-sm muted"></p>
        </div>
        <div class="text-sm text-gray-600">
          <p class="mb-2">Tips:</p>
          <ul class="list-disc list-inside space-y-1">
            <li>Use <span class="chip">Sign up</span> once, then <span class="chip">Login</span>.</li>
            <li>Your token is stored locally (browser) for API calls.</li>
            <li>All requests go to the same origin (no CORS issues).</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Tasks -->
    <section id="tasksCard" class="card hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-medium">My Tasks</h2>
        <div class="flex gap-2">
          <input id="filterInput" class="input !w-64" placeholder="Filter by title..." />
          <button id="refreshBtn" class="btn btn-ghost">Refresh</button>
        </div>
      </div>

      <form id="createForm" class="flex gap-2 mb-4">
        <input id="newTitle" class="input" placeholder="New task title..." required />
        <input id="newDesc" class="input !w-72" placeholder="Description (optional)" />
        <button class="btn btn-primary" type="submit">Add</button>
      </form>

      <div id="list" class="space-y-2"></div>

      <template id="rowTpl">
        <div class="flex items-start gap-3 p-3 rounded-xl border border-gray-200 bg-white">
          <input type="checkbox" class="mt-1" data-role="done">
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <span data-role="title" class="font-medium"></span>
              <span data-role="status" class="chip"></span>
            </div>
            <div data-role="desc" class="muted text-sm"></div>
            <div class="mt-2 flex gap-2">
              <button class="btn btn-ghost" data-role="edit">Edit</button>
              <button class="btn btn-ghost" data-role="save" style="display:none">Save</button>
              <button class="btn btn-ghost" data-role="cancel" style="display:none">Cancel</button>
              <button class="btn btn-ghost" data-role="delete">Delete</button>
            </div>
          </div>
        </div>
      </template>
    </section>
  </div>

  <script>
    const API = ""; // same-origin
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const state = { access: localStorage.getItem("access") || "", me: null, tasks: [] };

    // --- API helpers ---
    async function api(path, {method="GET", json, form, auth=true} = {}) {
      const headers = {};
      if (json) { headers["Content-Type"] = "application/json"; }
      if (auth && state.access) { headers["Authorization"] = "Bearer " + state.access; }

      const body = json ? JSON.stringify(json) : (form ? new URLSearchParams(form) : undefined);
      const res = await fetch(API + path, { method, headers, body });
      if (!res.ok) {
        const text = await res.text().catch(()=> "");
        throw new Error(text || (res.status + " " + res.statusText));
      }
      const ct = res.headers.get("content-type") || "";
      return ct.includes("application/json") ? res.json() : res.text();
    }

    // Auth endpoints
    const authApi = {
      signup: (email, password, full_name) => api("/api/auth/signup", {method:"POST", json:{email, password, full_name}, auth:false}),
      login: (email, password) => api("/api/auth/login", {method:"POST", form:{username:email, password}, auth:false}),
      me: () => api("/api/users/me"),
      logout: (refresh) => api("/api/auth/logout", {method:"POST", json:{refresh_token: refresh}}), // not used in UI, tokens kept client-side
    };

    // Tasks endpoints
    const tasksApi = {
      listMine: () => api("/api/tasks/"),
      create: (title, description) => api("/api/tasks/", {method:"POST", json:{title, description}}),
      patch: (id, payload) => api(`/api/tasks/${id}`, {method:"PATCH", json:payload}),
      del: (id) => api(`/api/tasks/${id}`, {method:"DELETE"}),
    };

    // --- UI state ---
    function setLoggedIn(me) {
      state.me = me;
      $("#userEmail").textContent = me.email;
      $("#userBox").classList.remove("hidden");
      $("#authCard").classList.add("hidden");
      $("#tasksCard").classList.remove("hidden");
      refreshTasks();
    }

    function setLoggedOut(msg="") {
      state.me = null;
      state.access = "";
      localStorage.removeItem("access");
      $("#userBox").classList.add("hidden");
      $("#authCard").classList.remove("hidden");
      $("#tasksCard").classList.add("hidden");
      $("#authMsg").textContent = msg;
    }

    // --- Render ---
    function renderList() {
      const filter = $("#filterInput").value.trim().toLowerCase();
      const list = $("#list");
      list.innerHTML = "";
      const tpl = $("#rowTpl");

      state.tasks
        .filter(t => !filter || t.title.toLowerCase().includes(filter))
        .forEach(task => {
          const node = tpl.content.cloneNode(true);
          const root = node.children[0];
          const done = $('[data-role="done"]', root);
          const title = $('[data-role="title"]', root);
          const desc = $('[data-role="desc"]', root);
          const status = $('[data-role="status"]', root);
          const btnEdit = $('[data-role="edit"]', root);
          const btnSave = $('[data-role="save"]', root);
          const btnCancel = $('[data-role="cancel"]', root);
          const btnDelete = $('[data-role="delete"]', root);

          title.textContent = task.title;
          desc.textContent = task.description || "—";
          status.textContent = task.is_completed ? "Done" : "Open";
          status.className = "chip " + (task.is_completed ? "bg-green-100" : "bg-gray-100");
          done.checked = !!task.is_completed;

          // toggle complete
          done.addEventListener("change", async () => {
            const updated = await tasksApi.patch(task.id, { is_completed: done.checked });
            task.is_completed = updated.is_completed;
            renderList();
          });

          // edit
          btnEdit.addEventListener("click", () => {
            btnEdit.style.display = "none";
            btnSave.style.display = "";
            btnCancel.style.display = "";

            const tIn = document.createElement("input");
            tIn.className = "input";
            tIn.value = task.title;

            const dIn = document.createElement("input");
            dIn.className = "input mt-2";
            dIn.value = task.description || "";

            title.replaceWith(tIn);
            desc.replaceWith(dIn);

            btnSave.onclick = async () => {
              const updated = await tasksApi.patch(task.id, { title: tIn.value, description: dIn.value });
              task.title = updated.title;
              task.description = updated.description;
              renderList();
            };
            btnCancel.onclick = () => renderList();
          });

          // delete
          btnDelete.addEventListener("click", async () => {
            if (!confirm("Delete this task?")) return;
            await tasksApi.del(task.id);
            state.tasks = state.tasks.filter(t => t.id !== task.id);
            renderList();
          });

          list.appendChild(node);
        });

      if (!list.children.length) {
        const empty = document.createElement("div");
        empty.className = "muted text-center py-10";
        empty.textContent = "No tasks yet.";
        list.appendChild(empty);
      }
    }

    async function refreshTasks() {
      state.tasks = await tasksApi.listMine();
      renderList();
    }

    // --- Events ---
    $("#signupBtn").addEventListener("click", async () => {
      const email = $("#email").value.trim();
      const password = $("#password").value;
      const full_name = $("#fullName").value.trim() || null;
      try {
        const res = await authApi.signup(email, password, full_name);
        state.access = res.access_token;
        localStorage.setItem("access", state.access);
        const me = await authApi.me();
        setLoggedIn(me);
      } catch (e) { $("#authMsg").textContent = e.message || "Signup failed"; }
    });

    $("#loginBtn").addEventListener("click", async () => {
      const email = $("#email").value.trim();
      const password = $("#password").value;
      try {
        const res = await authApi.login(email, password);
        state.access = res.access_token;
        localStorage.setItem("access", state.access);
        const me = await authApi.me();
        setLoggedIn(me);
      } catch (e) { $("#authMsg").textContent = e.message || "Login failed"; }
    });

    $("#logoutBtn").addEventListener("click", () => setLoggedOut("Logged out."));

    $("#createForm").addEventListener("submit", async (ev) => {
      ev.preventDefault();
      const title = $("#newTitle").value.trim();
      const description = $("#newDesc").value.trim();
      if (!title) return;
      const created = await tasksApi.create(title, description || null);
      state.tasks.unshift(created);
      $("#newTitle").value = "";
      $("#newDesc").value = "";
      renderList();
    });

    $("#refreshBtn").addEventListener("click", refreshTasks);
    $("#filterInput").addEventListener("input", renderList);

    // auto-login if token exists
    (async () => {
      if (!state.access) return;
      try {
        const me = await authApi.me();
        setLoggedIn(me);
      } catch {
        setLoggedOut();
      }
    })();
  </script>
</body>
</html>